name: ğŸ” Security and Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'

jobs:
  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: |
        npm audit --audit-level=critical
        npm audit --json > audit-results.json || true
        
    - name: Upload audit results
      uses: actions/upload-artifact@v3
      with:
        name: npm-audit-results
        path: audit-results.json
        
    - name: Check for hardcoded secrets
      run: |
        echo "ğŸ” Checking for potential hardcoded secrets..."
        # Check for common patterns
        if grep -r "password.*=" --include="*.js" --include="*.html" .; then
          echo "âš ï¸ Potential hardcoded password found!"
          exit 1
        fi
        if grep -r "api_key.*=" --include="*.js" --include="*.html" .; then
          echo "âš ï¸ Potential hardcoded API key found!"
          exit 1
        fi
        echo "âœ… No obvious hardcoded secrets detected"

  lighthouse-ci:
    name: ğŸƒâ€â™‚ï¸ Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Start development server
      run: |
        npm run dev &
        sleep 10  # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿ
        
    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun || echo "Lighthouse CI completed with warnings"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  code-quality:
    name: ğŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file structure
      run: |
        echo "ğŸ” Checking project structure..."
        
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        required_files=("index.html" "main.js" "README.md" "package.json")
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ Required file missing: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        security_files=("SECURITY.md" ".gitignore")
        for file in "${security_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âš ï¸ Security file missing: $file"
          else
            echo "âœ… Security file found: $file"
          fi
        done
        
    - name: Check for TODO items
      run: |
        echo "ğŸ“ Checking for TODO items..."
        todo_count=$(grep -r "TODO\|FIXME\|XXX\|HACK" --include="*.js" --include="*.html" --include="*.css" . | wc -l)
        echo "Found $todo_count TODO items"
        if [[ $todo_count -gt 10 ]]; then
          echo "âš ï¸ High number of TODO items detected ($todo_count)"
        fi

  accessibility-check:
    name: â™¿ Accessibility Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Start development server
      run: |
        npm run dev &
        sleep 10
        
    - name: Install axe-core CLI
      run: npm install -g @axe-core/cli
      
    - name: Run accessibility tests
      run: |
        axe http://localhost:8080 --exit || echo "Accessibility issues detected"

  create-issue-on-failure:
    name: ğŸ“ Create Issue on Failure
    runs-on: ubuntu-latest
    needs: [security-audit, lighthouse-ci, code-quality, accessibility-check]
    if: failure()
    
    steps:
    - name: Create issue on failure
      uses: actions/github-script@v6
      with:
        script: |
          const title = `ğŸš¨ Automated Quality Check Failed - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## è‡ªå‹•å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ
          
          **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toISOString()}
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}
          **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}
          **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          
          ### ç¢ºèªäº‹é …
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã®çµæœã‚’ç¢ºèª
          - [ ] Lighthouseã‚¹ã‚³ã‚¢ã®ç¢ºèª
          - [ ] ã‚³ãƒ¼ãƒ‰å“è³ªã®å•é¡Œã‚’ä¿®æ­£
          - [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®å•é¡Œã‚’ä¿®æ­£
          
          ### è©³ç´°
          è©³ç´°ã¯[Actionså®Ÿè¡Œçµæœ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          
          ---
          *ã“ã®issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['automated', 'quality-check', 'priority-high']
          });
