name: ï¿½ Lighthouse Performance Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯æ—¥ JST 9:00 (UTC 0:00) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  lighthouse-check:
    name: ğŸ” Lighthouse CI
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        # Lighthouseã¯@lhci/cliã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€å€‹åˆ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦

    - name: Start development server
      run: |
        npm run dev &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§æœ€å¤§60ç§’å¾…æ©Ÿ
        echo "Waiting for server to start..."
        for i in {1..12}; do
          if curl -f http://localhost:8080 > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "Attempt $i/12: Server not ready, waiting 5 seconds..."
          sleep 5
        done
        
        # æœ€çµ‚ç¢ºèª
        if ! curl -f http://localhost:8080 > /dev/null 2>&1; then
          echo "âŒ Server failed to start"
          exit 1
        fi

    - name: Run Lighthouse CI
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      run: npx lhci autorun

    - name: Stop development server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-results
        path: |
          .lighthouseci/
          lighthouse-results/

  lighthouse-desktop:
    name: ğŸ–¥ï¸ Lighthouse Desktop
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Start development server
      run: |
        npm run dev &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿ
        for i in {1..12}; do
          if curl -f http://localhost:8080 > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "Attempt $i/12: Server not ready, waiting 5 seconds..."
          sleep 5
        done

    - name: Run Lighthouse (Desktop)
      run: |
        npx lighthouse http://localhost:8080 \
          --preset=desktop \
          --output=json,html \
          --output-path=./lighthouse-desktop \
          --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
          --quiet

    - name: Parse Lighthouse scores
      run: |
        echo "## ğŸ“Š Lighthouse Desktop Scores" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Score |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        
        # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¹ã‚³ã‚¢ã‚’æŠ½å‡ºï¼ˆnullå€¤ã«å¯¾å¿œï¼‰
        performance=$(jq -r '.categories.performance.score // 0 | . * 100 | floor' lighthouse-desktop.report.json)
        accessibility=$(jq -r '.categories.accessibility.score // 0 | . * 100 | floor' lighthouse-desktop.report.json)
        best_practices=$(jq -r '.categories["best-practices"].score // 0 | . * 100 | floor' lighthouse-desktop.report.json)
        seo=$(jq -r '.categories.seo.score // 0 | . * 100 | floor' lighthouse-desktop.report.json)
        pwa=$(jq -r '.categories.pwa.score // 0 | . * 100 | floor' lighthouse-desktop.report.json)
        
        echo "| Performance | ${performance}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Accessibility | ${accessibility}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Best Practices | ${best_practices}% |" >> $GITHUB_STEP_SUMMARY
        echo "| SEO | ${seo}% |" >> $GITHUB_STEP_SUMMARY
        echo "| PWA | ${pwa}% |" >> $GITHUB_STEP_SUMMARY

    - name: Stop development server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

    - name: Upload Desktop results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-desktop-results
        path: lighthouse-desktop.*

  lighthouse-mobile:
    name: ğŸ“± Lighthouse Mobile
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Start development server
      run: |
        npm run dev &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿ
        for i in {1..12}; do
          if curl -f http://localhost:8080 > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "Attempt $i/12: Server not ready, waiting 5 seconds..."
          sleep 5
        done

    - name: Run Lighthouse (Mobile)
      run: |
        npx lighthouse http://localhost:8080 \
          --preset=perf \
          --output=json,html \
          --output-path=./lighthouse-mobile \
          --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
          --quiet

    - name: Parse Mobile scores
      run: |
        echo "## ğŸ“± Lighthouse Mobile Scores" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Score |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        
        performance=$(jq -r '.categories.performance.score // 0 | . * 100 | floor' lighthouse-mobile.report.json)
        accessibility=$(jq -r '.categories.accessibility.score // 0 | . * 100 | floor' lighthouse-mobile.report.json)
        best_practices=$(jq -r '.categories["best-practices"].score // 0 | . * 100 | floor' lighthouse-mobile.report.json)
        seo=$(jq -r '.categories.seo.score // 0 | . * 100 | floor' lighthouse-mobile.report.json)
        pwa=$(jq -r '.categories.pwa.score // 0 | . * 100 | floor' lighthouse-mobile.report.json)
        
        echo "| Performance | ${performance}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Accessibility | ${accessibility}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Best Practices | ${best_practices}% |" >> $GITHUB_STEP_SUMMARY
        echo "| SEO | ${seo}% |" >> $GITHUB_STEP_SUMMARY
        echo "| PWA | ${pwa}% |" >> $GITHUB_STEP_SUMMARY

    - name: Stop development server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

    - name: Upload Mobile results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-mobile-results
        path: lighthouse-mobile.*

  performance-monitoring:
    name: ğŸ“ˆ Performance Monitoring
    runs-on: ubuntu-latest
    needs: [lighthouse-check, lighthouse-desktop, lighthouse-mobile]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate performance report
      run: |
        echo "# ğŸ“Š Performance Monitoring Report" > performance-report.md
        echo "" >> performance-report.md
        echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date)" >> performance-report.md
        echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}" >> performance-report.md
        echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> performance-report.md
        echo "" >> performance-report.md
        
        echo "## ğŸ¯ Performance Thresholds" >> performance-report.md
        echo "- **Performance**: 80% ä»¥ä¸Š" >> performance-report.md
        echo "- **Accessibility**: 90% ä»¥ä¸Š" >> performance-report.md
        echo "- **Best Practices**: 90% ä»¥ä¸Š" >> performance-report.md
        echo "- **SEO**: 80% ä»¥ä¸Š" >> performance-report.md
        echo "- **PWA**: 50% ä»¥ä¸Š" >> performance-report.md
        echo "" >> performance-report.md
        
        echo "## ğŸ“± Test Results" >> performance-report.md
        echo "è©³ç´°ãªçµæœã¯å„ã‚¸ãƒ§ãƒ–ã®Artifactsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> performance-report.md

    - name: Create issue on performance regression
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ğŸš¨ Performance Regression Detected - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
          
          **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toISOString()}
          **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}
          **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          
          ### ç¢ºèªäº‹é …
          - [ ] Lighthouseã‚¹ã‚³ã‚¢ã®è©³ç´°ç¢ºèª
          - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã®åŸå› ç‰¹å®š
          - [ ] å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£å®Ÿæ–½
          
          ### ã‚¹ã‚³ã‚¢é–¾å€¤
          - Performance: 80%ä»¥ä¸Š
          - Accessibility: 90%ä»¥ä¸Š
          - Best Practices: 90%ä»¥ä¸Š
          - SEO: 80%ä»¥ä¸Š
          - PWA: 50%ä»¥ä¸Š
          
          ### è©³ç´°
          [Actionså®Ÿè¡Œçµæœ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          *ã“ã®issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['performance', 'regression', 'automated']
          });
